<html>
<head>
	<title>Tornado Template</title>
</head>
<body>
	<h2>userid: {{userid}}</h2>


	<script>

		var peerConnections = {};

		var startRTCConnection = function (targetPeerID) {
			// -----------------------------------
			// not sure where this code goes     
			// -----------------------------------

			var iceServers = {'iceServers': [{url: 'stun:stun.l.google.com:19302'}]};
			var optionalRtpDataChannels = { 'optional': [{'DtlsSrtpKeyAgreement': true}, {'RtpDataChannels': true }] };

			// -----------------------------------

			peerConnection = new webkitRTCPeerConnection(iceServers, optionalRtpDataChannels);

			peerConnections[targetPeerID] = peerConnection;

			var dataChannel = peerConnection.createDataChannel('RTCDataChannel', {reliable: false
			});

			alert('dataChannel: ' + dataChannel);
		}



		var ServerEventHandler = function (id, route) {
			var websocket = new WebSocket("ws" + document.location.origin.substring(4) + "/" + route);

			var wsEventsDict = {
				"alert" : function (message) {alert(message);},
				"log" : function (message) {console.log(message);},
				"startRTCConnection" : function (targetPeerID) {
					startRTCConnection(targetPeerID);
				}
			}

			var wsEventsHandler = function (event) {
				var Instructions = JSON.parse(event.data).Instructions;

				if (Instructions.Command in wsEventsDict) {
					wsEventsDict[Instructions.Command](Instructions.Body);
				} else {
					console.log(Instructions.Command + " is not a registered event");
				}

			}

			var websocketEventHandlers = websocket.addEventListener('message', wsEventsHandler);

			this.send = function (recipient, message) {
				var payload = {
					"SenderID" : userid,
					"RecipientID" : recipient,
					"Instructions" : message
				}

			window.payload = payload;
			websocket.send(JSON.stringify(payload));
			}
		}

	</script>




	<script>
		var userid = "{{userid}}";
	
		var eventer = new ServerEventHandler(userid, "signalsocket");
	</script>


</body>
</html>